// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------

enum UserRole {
  RESEARCHER
  PARTICIPANT
  ADMIN
}

model User {
  id             Int      @id @default(autoincrement())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  firstname      String?
  lastname       String?
  username       String?
  email          String   @unique
  hashedPassword String?
  role           UserRole

  language String @default("en-US")

  tokens   Token[]
  sessions Session[]

  gravatar String?

  // Relations
  studies                StudyResearcher[] // researcher memberships
  participations         ParticipantStudy[] // participant memberships
  Study                  Study[]
  notificationRecipients NotificationRecipient[]
  AdminInvite            AdminInvite[]
}

model Session {
  id                 Int       @id @default(autoincrement())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?
}

enum TokenType {
  RESET_PASSWORD
  CONFIRM_EMAIL
}

model Token {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  hashedToken String
  type        TokenType
  expiresAt   DateTime
  sentTo      String

  user   User @relation(fields: [userId], references: [id])
  userId Int

  @@unique([hashedToken, type])
}

enum StudyStatus {
  OPEN
  CLOSED
}

enum JatosWorkerType {
  SINGLE
  MULTIPLE
}

model Study {
  // Basic information
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  title       String
  description String

  // Study configuration
  status     StudyStatus @default(CLOSED) // Whether study is open for datacollection (can be set manually)
  startDate  DateTime // Expected startDate of data collection, study opens at startDate automatically
  endDate    DateTime // Expected endDate of data collection, study closes at endDate automatically 
  sampleSize Int // Number of participants to be collected
  payment    String // Description of payment method
  length     String // e.g. "30 minutes", stored as text

  // JATOS integration
  jatosStudyId       Int? // ID returned from JATOS after import
  jatosStudyUUID     String?          @unique // optional, JATOS also has UUIDs 
  jatosFileName      String? // original uploaded filename
  // JATOS component fields
  jatosComponentId   Int?
  jatosComponentUUID String?
  // JATOS batches
  jatosBatchId       Int?
  // JATOS workers
  jatosWorkerType    JatosWorkerType? @default(SINGLE)

  // Archival
  archived     Boolean   @default(false)
  archivedAt   DateTime?
  archivedById Int?
  archivedBy   User?     @relation(fields: [archivedById], references: [id])

  // Relations
  researchers      StudyResearcher[]
  participations   ParticipantStudy[]
  FeedbackTemplate FeedbackTemplate[]
  StudyVariable    StudyVariable[]

  // Setup completion tracking
  // These fields track explicit completion of each setup step
  step1Completed Boolean @default(false) // General information completed (title + description)
  step2Completed Boolean @default(false) // JATOS study imported (jatosStudyId + jatosStudyUUID exist)
  step3Completed Boolean @default(false) // Test run completed (pilot test finished + test data available)
  step4Completed Boolean @default(false) // Feedback template created (FeedbackTemplate exists)

  @@index([archived, createdAt])
}

enum ResearcherRole {
  PI
  COLLABORATOR
  VIEWER
}

model Notification {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  message      String
  announcement Boolean  @default(false)
  routeData    Json? // Flexible JSON field to store dynamic routing data

  recipients NotificationRecipient[]
}

model NotificationRecipient {
  notificationId Int
  userId         Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  readAt         DateTime?
  dismissedAt    DateTime?
  pinned         Boolean   @default(false)

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([notificationId, userId])
  @@index([userId, readAt])
}

model StudyResearcher {
  id      Int @id @default(autoincrement())
  studyId Int
  userId  Int

  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  jatosRunUrl String? // stored personal single link

  role      ResearcherRole @default(PI)
  createdAt DateTime       @default(now())

  @@unique([studyId, userId])
}

model StudyVariable {
  id        Int      @id @default(autoincrement())
  studyId   Int
  name      String // e.g. "score" or "reaction_time"
  label     String? // optional human-readable label
  type      String? // e.g. "number", "string", "boolean"
  example   String? // optional example value from trial run
  createdAt DateTime @default(now())

  study Study @relation(fields: [studyId], references: [id])

  @@unique([studyId, name])
}

model ParticipantStudy {
  id      Int @id @default(autoincrement())
  userId  Int
  studyId Int

  pseudonym   String  @default(uuid())
  jatosRunUrl String? // stored personal single link

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  payed  Boolean @default(false)
  active Boolean @default(true)

  @@unique([userId, studyId])
}

model FeedbackTemplate {
  id        Int      @id @default(autoincrement())
  studyId   Int      @unique
  content   String // raw markdown with placeholders, e.g. "Your score: {{score}}"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  study Study @relation(fields: [studyId], references: [id])
}

model AdminInvite {
  id             Int       @id @default(autoincrement())
  token          String    @unique // random, single-use, stored server-side only
  email          String
  expiresAt      DateTime
  redeemedAt     DateTime?
  revokedAt      DateTime?
  reminderSentAt DateTime? // Track when reminder email was last sent
  createdAt      DateTime  @default(now())
  createdById    Int?
  createdBy      User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([expiresAt])
}
