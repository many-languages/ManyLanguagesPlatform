// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------

enum UserRole {
  RESEARCHER
  PARTICIPANT
  ADMIN
}

model User {
  id             Int      @id @default(autoincrement())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  firstname      String?
  lastname       String?
  username       String?
  email          String   @unique
  hashedPassword String?
  role           UserRole

  language String @default("en-US")

  tokens   Token[]
  sessions Session[]

  gravatar String?

  // Relations
  studies                StudyResearcher[] // researcher memberships
  participations         ParticipantStudy[] // participant memberships
  Study                  Study[]
  notificationRecipients NotificationRecipient[]
  AdminInvite            AdminInvite[]
}

model Session {
  id                 Int       @id @default(autoincrement())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?
}

enum TokenType {
  RESET_PASSWORD
  CONFIRM_EMAIL
}

model Token {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  hashedToken String
  type        TokenType
  expiresAt   DateTime
  sentTo      String

  user   User @relation(fields: [userId], references: [id])
  userId Int

  @@unique([hashedToken, type])
}

enum ExtractionSnapshotStatus {
  DRAFT
  APPROVED
}

enum StudyStatus {
  OPEN
  CLOSED
}

enum JatosWorkerType {
  SINGLE
  MULTIPLE
}

model Study {
  // Basic information
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  title       String
  description String

  // Study configuration
  status     StudyStatus @default(CLOSED) // Whether study is open for datacollection (can be set manually)
  startDate  DateTime // Expected startDate of data collection, study opens at startDate automatically
  endDate    DateTime // Expected endDate of data collection, study closes at endDate automatically 
  sampleSize Int // Number of participants to be collected
  payment    String // Description of payment method
  length     String // e.g. "30 minutes", stored as text

  // JATOS integration
  jatosStudyUUID String? @unique // optional, JATOS also has UUIDs 

  // JATOS study uploads (versioned builds)
  jatosStudyUploads JatosStudyUpload[] @relation("StudyJatosUploads")

  // Versioned data lives on JatosStudyUpload

  // Archival
  archived     Boolean   @default(false)
  archivedAt   DateTime?
  archivedById Int?
  archivedBy   User?     @relation(fields: [archivedById], references: [id])

  // Relations
  researchers      StudyResearcher[]
  participations   ParticipantStudy[]
  FeedbackTemplate FeedbackTemplate?

  @@index([archived, createdAt])
}

enum ResearcherRole {
  PI
  COLLABORATOR
  VIEWER
}

model Notification {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  message      String
  announcement Boolean  @default(false)
  routeData    Json? // Flexible JSON field to store dynamic routing data

  recipients NotificationRecipient[]
}

model NotificationRecipient {
  notificationId Int
  userId         Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  readAt         DateTime?
  dismissedAt    DateTime?
  pinned         Boolean   @default(false)

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([notificationId, userId])
  @@index([userId, readAt])
}

model StudyResearcher {
  id      Int @id @default(autoincrement())
  studyId Int
  userId  Int

  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  role       ResearcherRole @default(PI)
  createdAt  DateTime       @default(now())
  pilotLinks PilotLink[]

  @@unique([studyId, userId])
}

model StudyVariable {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  extractionSnapshotId Int

  variableKey  String
  variableName String
  type         String
  examples     Json?

  description  String?
  personalData Boolean @default(false)

  extractionSnapshot ExtractionSnapshot @relation(fields: [extractionSnapshotId], references: [id], onDelete: Cascade)

  @@unique([extractionSnapshotId, variableKey])
  @@index([extractionSnapshotId])
}

model ParticipantStudy {
  id      Int @id @default(autoincrement())
  userId  Int
  studyId Int

  pseudonym   String  @default(uuid())
  jatosRunUrl String? // stored personal single link

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  payed  Boolean @default(false)
  active Boolean @default(true)

  @@unique([userId, studyId])
}

enum ValidationStatus {
  NEEDS_REVIEW
  VALID
  INVALID
}

model FeedbackTemplate {
  id      Int @id @default(autoincrement())
  studyId Int @unique

  validatedExtractionId Int?
  validatedExtraction   ExtractionSnapshot? @relation("ValidatedExtraction", fields: [validatedExtractionId], references: [id], onDelete: SetNull)
  validationStatus      ValidationStatus    @default(NEEDS_REVIEW)
  validatedAt           DateTime?
  missingKeys           Json? // string[]
  extraKeys             Json? // string[]

  content              String
  requiredVariableKeys Json? // string[]
  extractorVersion     String? // safety check

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
}

model AdminInvite {
  id             Int       @id @default(autoincrement())
  token          String    @unique // random, single-use, stored server-side only
  email          String
  expiresAt      DateTime
  redeemedAt     DateTime?
  revokedAt      DateTime?
  reminderSentAt DateTime? // Track when reminder email was last sent
  createdAt      DateTime  @default(now())
  createdById    Int?
  createdBy      User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([expiresAt])
}

model PilotLink {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  studyResearcherId  Int
  jatosStudyUploadId Int

  jatosRunUrl String
  markerToken String @unique

  researcher       StudyResearcher  @relation(fields: [studyResearcherId], references: [id], onDelete: Cascade)
  jatosStudyUpload JatosStudyUpload @relation(fields: [jatosStudyUploadId], references: [id], onDelete: Cascade)

  @@index([studyResearcherId, createdAt])
  @@index([jatosStudyUploadId, createdAt])
}

model PilotDatasetSnapshot {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  jatosStudyUploadId Int

  pilotDatasetHash String
  pilotRunCount    Int
  pilotRunIds      Json?
  markerTokens     Json // string[]

  jatosStudyUpload JatosStudyUpload @relation(fields: [jatosStudyUploadId], references: [id], onDelete: Cascade)

  extractions ExtractionSnapshot[]

  @@unique([jatosStudyUploadId, pilotDatasetHash])
  @@index([jatosStudyUploadId, createdAt])
}

model ExtractionSnapshot {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  approvedAt DateTime?

  status             ExtractionSnapshotStatus @default(DRAFT)
  jatosStudyUploadId Int

  pilotDatasetSnapshotId Int
  pilotDatasetSnapshot   PilotDatasetSnapshot @relation(fields: [pilotDatasetSnapshotId], references: [id], onDelete: Restrict)

  extractorVersion    String
  extractorConfigHash String?
  outputHash          String?
  structureSummary    Json?
  aggregates          Json?

  jatosStudyUpload JatosStudyUpload @relation("UploadExtractions", fields: [jatosStudyUploadId], references: [id], onDelete: Cascade)
  variables        StudyVariable[]

  approvedForUpload          JatosStudyUpload?  @relation("ApprovedExtractionForUpload")
  validatedFeedbackTemplates FeedbackTemplate[] @relation("ValidatedExtraction")

  @@index([jatosStudyUploadId, status, createdAt])
}

model JatosStudyUpload {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  studyId       Int
  versionNumber Int

  jatosStudyId  Int
  jatosFileName String

  // JATOS component fields
  jatosComponentId   Int?
  jatosComponentUUID String?
  // JATOS batches
  jatosBatchId       Int?
  // JATOS workers
  jatosWorkerType    JatosWorkerType @default(SINGLE)

  buildHash     String
  hashAlgorithm String @default("sha256")

  study Study @relation("StudyJatosUploads", fields: [studyId], references: [id], onDelete: Cascade)

  pilotLinks            PilotLink[]
  pilotDatasetSnapshots PilotDatasetSnapshot[]
  extractionSnapshots   ExtractionSnapshot[]   @relation("UploadExtractions")

  approvedExtractionId Int?                @unique
  approvedExtraction   ExtractionSnapshot? @relation("ApprovedExtractionForUpload", fields: [approvedExtractionId], references: [id], onDelete: SetNull)

  // Setup completion tracking (per upload)
  step1Completed Boolean @default(false) // General information completed
  step2Completed Boolean @default(false) // JATOS study imported
  step3Completed Boolean @default(false) // Test run completed
  step4Completed Boolean @default(false) // Debug completed
  step5Completed Boolean @default(false) // Codebook completed
  step6Completed Boolean @default(false) // Feedback template created

  @@unique([studyId, versionNumber])
  @@unique([studyId, buildHash])
  @@index([studyId, createdAt])
  @@index([buildHash])
}
